worker_processes auto;

events { worker_connections 1024; }

http {
  # Sensible defaults
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  tcp_nodelay   on;
  keepalive_timeout  65;
  server_tokens off;

  # Cache for PXE artifacts
  proxy_cache_path /var/cache/nginx/fcos levels=1:2 keys_zone=fcos_artifacts:50m
                   inactive=14d max_size=30g;

  # Shared dict to cache streams JSON + ETag
  lua_shared_dict fcos_meta 1m;
  
  lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
  lua_ssl_verify_depth 5;

  # Lua module search path (opm installs under site/lualib)
  lua_package_path "/usr/local/openresty/site/lualib/?.lua;;";

  log_format main '$remote_addr - $request $status $body_bytes_sent '
                  '$upstream_cache_status $request_time "$http_user_agent"';
  access_log /dev/stdout main;
  error_log  /dev/stderr info;

  include /etc/nginx/conf.d/*.conf;
}
